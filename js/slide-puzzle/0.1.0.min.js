/* 
 * jquery.slidepuzzlize 0.1.0
 * MIT Licensed
 * 
 * Copyright (C) pentamania, https://github.com/pentamania
 */

!function(e){var t=function(e,t){for(e.length=0,i=0;i<t;i++)e.push(i)},r=function(e){return Array.prototype.slice.call(arguments,1).forEach(function(t){var r,i;if(t)for(i in t)r=Object.getOwnPropertyDescriptor(t,i),Object.defineProperty(e,i,r)}),e},n=function(e,t,r,i,n){for(var o=null!=n?n:e.length-1,s=0;s<i;s++){var a=[],c=Math.floor(o/t),u=o%t;0!==c&&a.push(o-t),c!==r-1&&a.push(o+t),0!==u&&a.push(o-1),u!==t-1&&a.push(o+1);var f=a[Math.floor(Math.random()*a.length)],h=e[f];e[f]=e[o],e[o]=h,o=f}},o=function(t){var r=e.Deferred(),i=new Image;if("string"==typeof t)i.src=t;else{if(null==t.src)return console.error("imgタグか、src文字列を渡して下さい"),!1;i.src=t.src}return i.onload=function(){r.resolve(i)},i.onerror=function(e){r.reject(e)},setTimeout(function(){r.reject()},2e3),r.promise()},s=function(e){var t=1e3;return e&&(t=e),(new Date).getTime().toString(16)+Math.floor(t*Math.random()).toString(16)},a=function(t){var r=document.getElementById(t);return e(r)};e.extend({slidePuzzlize:function(i){if(null!=(i=e.extend({col:4,row:4,pieceOpacity:.6,animateDuration:150,borderColor:"#565656"},i)).selector)c=e(i.selector);else{var c=e("<div/>");e("body").append(c)}var u=i.col,f=i.row,h=i.animateDuration,p=i.pieceOpacity,l=i.borderColor,d=i.width||c.width(),g=i.height||c.height(),m=i.enableAnimation||!0,v=!1,b="jspz_"+s(),x=16,w=[],y=[],D=[],_=!0,z="function"==typeof e().animate,M=function(t,r){var i,n,o,s,p,d,g=[],x=[],w=y,D=r.width(),M=r.height(),O=y.length-1,j=b+"_"+O,I=D/u,N=M/f,k={width:I+"px",height:N+"px",border:"1px solid "+l,"box-sizing":"border-box",float:"left",overflow:"hidden",position:"relative",cursor:"pointer"},A=e.extend({},k,{visibility:"hidden"});t.width=D,t.height=M;for(var S=0;S<f;S++)for(var E=0;E<u;E++)x.push([E,S]);for(var P=0,C=w.length;P<C;P++)n=w[P],o=b+"_"+n,s=-(I*x[n][0])+"px",p=-(N*x[n][1])+"px",d=e(t.cloneNode(!1)).css({left:s,top:p,position:"absolute",maxWidth:"none"}),(i=o===j?e("<div/>").attr("id",o).css(A):e("<div/>").attr("id",o).css(k).append(d)).on("touchstart mousedown",function(t){if(t.preventDefault(),!v&&_){_=!1;var r,i,n,o,s,p,l=+e(this).attr("id").replace(b+"_",""),d=w.indexOf(l),g=Math.floor(d/u)*u,x=d%u,y=!1,D="-="+N+"px",M="+="+N+"px",j="-="+I+"px",k="+="+I+"px",A=function(e,t){z&&m?e.animate(t,h):e.css(t)};for(r=0;r<u;r++)if(n=g+r,(o=w[n])===O){if(s=Math.abs(n-d),n<d){for(i=0;i<s;i++)p=b+"_"+w[d-i],A(a(p),{left:j});for(i=0;i<s;i++)w[n+i]=w[n+(i+1)];w[d]=o}else{for(i=0;i<s;i++)p=b+"_"+w[d+i],A(a(p),{left:k});for(i=0;i<s;i++)w[n-i]=w[n-(i+1)];w[d]=o}y=!0;break}if(!y)for(r=0;r<f;r++)if(n=x+u*r,(o=w[n])===O){if(s=Math.abs(n-d)/u,n<d){for(i=0;i<s;i++)p=b+"_"+w[d-u*i],A(a(p),{top:D});for(i=0;i<s;i++)w[n+u*i]=w[n+u*(i+1)];w[d]=o}else{for(i=0;i<s;i++)p=b+"_"+w[d+u*i],A(a(p),{top:M});for(i=0;i<s;i++)w[n-u*i]=w[n-u*(i+1)];w[d]=o}break}c.trigger("_piecemove"),c.trigger("piecemove"),_=!0}}),r.append(i),g.push(i);return g},O=function(){var e=!0;return w.forEach(function(t,r){var i=a(b+"_"+t);t===y[r]?i.css("opacity","1"):(i.css("opacity",p),e=!1)}),e};return r(c,{get UID(){return b},get row(){return f},get col(){return u},get pieceNum(){return u*f},get pieceOpacity(){return p},set pieceOpacity(e){p=e,O()},get animateDuration(){return h},set animateDuration(e){h=e},get enableAnimation(){return m},set enableAnimation(e){m=e},get shuffleStrength(){return x},set shuffleStrength(e){x=e},get isLocked(){return v},set isLocked(e){v=e},pieces:[],image:new Image,shuffle:function(){return t(y,this.pieceNum),n(y,u,f,this.pieceNum*x),D=[].concat(y),this.reset(y),this.trigger("shuffle"),this},setGrid:function(e,r){null!=e&&(u=e),null!=r&&(f=r);var i=this.pieceNum;return t(w,i),t(y,i),t(D,i),this},setImage:function(t,r){var i=e.Deferred(),n=this;return o(t).then(function(e){n.image=e,r||n.resize(e.width,e.height),i.resolveWith(n,[e])}).catch(function(){i.reject()}),i.promise()},resize:function(e,t){return e&&(d=e),t&&(g=t),this.css({width:d+"px",height:g+"px"}),this},reset:function(e){return y=e||[].concat(D),this.empty(),this.pieces=M(this.image,this),O(),this}}),c.setGrid().on("_piecemove",function(){O()&&c.trigger("match")}),c.on("touchstart mousedown",function(e){e.preventDefault()}),c.resize(),c}})}(jQuery);